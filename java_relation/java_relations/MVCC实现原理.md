### MVCC实现原理

`InnoDB` 中 `MVCC` 的实现方式为：每一行记录都有两个隐藏列： `DATA_TRX_ID` 、 `DATA_ROLL_PTR` （如果没有主键，则还会多一个隐藏的主键列）。

- `DATA_TRX_ID`

记录最近更新这条行记录的 `事务 ID` ，大小为 `6` 个字节

- `DATA_ROLL_PTR`

表示指向该行回滚段 `（rollback segment）` 的指针，大小为 `7` 个字节， `InnoDB` 便是通过这个指针找到之前版本的数据。该行记录上所有旧版本，在 `undo` 中都通过链表的形式组织。

在多个事务并行操作某行数据的情况下，不同事务对该行数据的 `UPDATE `会产生多个版本，然后通过回滚指针组织成一条 `Undo Log` 链。

`MVCC` 的例子，事务 `A` 对值 `x` 进行更新之后，该行即产生一个新版本和旧版本。假设之前插入该行的事务 `ID` 为 `100` ，事务 `A` 的 `ID` 为 `200` ，该行的隐藏主键为 `1` 。

![InnoDB MVCC 机制，看这篇就够了](https://img1.3s78.com/codercto/ab36e68439be8c763c93505d34fcd72c)

1. 对 `DB_ROW_ID = 1` 的这行记录加排他锁
2. 把该行原本的值拷贝到 `undo log` 中， `DB_TRX_ID` 和 `DB_ROLL_PTR` 都不动
3. 修改该行的值这时产生一个新版本，更新 `DATA_TRX_ID` 为修改记录的事务 `ID` ，将 `DATA_ROLL_PTR` 指向刚刚拷贝到 `undo log` 链中的旧版本记录，这样就能通过 `DB_ROLL_PTR` 找到这条记录的历史版本。如果对同一行记录执行连续的 `UPDATE` ， `Undo Log` 会组成一个链表，遍历这个链表可以看到这条记录的变迁
4. 记录 `redo log` ，包括 `undo log` 中的修改

## MVCC--多版本并发控制

### 1、定义：

　　MVCC（Multi-Version Concurrency Control，多版本并发控制）一种并发控制机制，在数据库中用来控制并发执行的事务，控制事务隔离进行。

### 2、核心思想：

　　MVCC是通过保存数据在某个时间点的快照来进行控制的。使用MVCC就是允许同一个数据记录拥有多个不同的版本。然后在查询时通过添加相对应的约束条件，就可以获取用户想要的对应版本的数据。



